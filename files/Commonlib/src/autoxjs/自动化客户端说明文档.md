# 自动化客户端程序说明文档

## 前言

本程序实现了一个基于 WebSocket 的客户端，用于与服务器进行实时通信。客户端支持身份验证、消息处理、错误处理和自动重连等功能，确保通信的稳定性和安全性。以下是程序的详细说明：

### 一、功能概述
1. **身份验证**：通过 HTTP 请求验证设备身份，确保只有合法设备能够与服务器建立连接。
2. **消息处理**：客户端能够接收服务器发送的消息，并根据消息内容执行相应的操作。
3. **错误处理**：程序包含错误处理机制，能够处理 WebSocket 连接中的错误事件，并尝试重新连接。
4. **自动重连**：支持自动重连功能，确保 WebSocket 连接的稳定性。

### 二、配置文件

1. **配置文件路径**  
   配置文件存储在以下路径：
   ```
   /storage/emulated/0/auto_config.json
   ```

2. **配置文件内容（示例）**
   ```json
   {
       "config": {
           "uri_ws": "ws://192.168.0.24:8500",
           "uri_code": "http://192.168.0.24:8502/code",
           "running": true,
           "reconnect": true,
           "timeout": 5000
       },
       "message": {
           "secret": "device-secret",
           "code": "",
           "device": "device-id",
           "type": "default.apk"
       }
   }
   ```

3. **配置项说明**
   - `config`
     - `uri_ws`: WebSocket 服务器的连接地址。
     - `uri_code`: 验证码获取的 HTTP API 地址。
     - `running`: 程序是否运行。
     - `reconnect`: 是否启用自动重连功能。
     - `timeout`: HTTP 请求和重连的超时时间（单位：毫秒）。
   - `message`
     - `secret`: 设备的唯一标识符（如设备的 Android ID）。
     - `code`: 验证码（通过 HTTP 请求获取）。
     - `device`: 设备的唯一标识符（与 `secret` 一致）。
     - `type`: 消息类型（如 `default.apk`）。

### 三、程序模块说明

1. **_open_ 函数**
   - **功能**：在 WebSocket 连接建立后，进行身份验证。
   - **逻辑**：
     1. 通过 HTTP GET 请求获取验证码。
     2. 验证成功后，将验证信息发送至服务器。
     3. 打印 WebSocket 连接和验证信息。
     4. 如果验证失败，关闭 WebSocket 连接。

2. **_message_ 函数**
   - **功能**：接收服务器发送的消息，并进行处理。
   - **逻辑**：
     1. 解析接收到的消息。
     2. 如果消息中包含 `data`，则执行以下操作：
        - 设置消息的 `device` 和 `type`。
        - 执行消息中的代码（通过 `eval`）。
        - 如果执行成功，返回执行结果；如果执行失败，返回错误信息。
     3. 如果解析消息失败，返回错误信息。

3. **_error_ 函数**
   - **功能**：处理 WebSocket 连接中的错误事件。
   - **逻辑**：
     1. 打印错误信息。
     2. 设置 `reconnect` 为 `true`，尝试重新连接。

4. **_close_ 函数**
   - **功能**：处理 WebSocket 连接关闭事件。
   - **逻辑**：
     1. 打印关闭信息。
     2. 设置 `reconnect` 为 `true`，尝试重新连接。

5. **_websocket_ 函数**
   - **功能**：管理 WebSocket 连接。
   - **逻辑**：
     1. 每隔 `timeout` 时间检查是否需要重新连接。
     2. 如果需要重新连接，创建新的 WebSocket 连接。
     3. 监听 WebSocket 的 `open`、`text`、`failure` 和 `closing` 事件。

6. **main 函数**
   - **功能**：初始化程序并启动 WebSocket 客户端。
   - **逻辑**：
     1. 读取配置文件，如果文件不存在则创建默认配置。
     2. 如果 `running` 为 `true`，启动 WebSocket 客户端。

### 四、程序启动

- **启动方式**：通过调用 `main` 函数启动程序，并传入配置文件路径。
  ```javascript
  main("/storage/emulated/0/auto_config.json");
  ```

### 五、注意事项

1. **身份验证**：确保 `uri_code` 配置正确，以便获取验证码。
2. **消息处理**：消息中的代码通过 `eval` 执行，可能存在安全风险，请确保消息来源可信。
3. **自动重连**：程序支持自动重连功能，确保 WebSocket 连接的稳定性。
4. **配置文件**：配置文件存储在指定路径，确保路径可读写。

### 六、技术支持与联系方式

若您在使用本程序遇到问题，请联系技术支持团队：
- **邮箱**：support@yourcompany.com
- **官方网站**：[https://www.yourcompany.com](https://www.yourcompany.com)
