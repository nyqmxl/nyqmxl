# 消息队列数据库说明

#### 前言

消息队列数据通过 WebSocket 客户端进行管理，所有基于 WebSocket 设计的客户端均可接入。消息队列数据库具有以下特点：

- WebSocket 客户端主动断开服务器时，所有相关消息队列数据将被删除。
- 开发者需严格按照接入格式使用，避免数据解析错误。

## 一、配置服务端

### 配置文件数据

```json
{
    "database_config": {
        "basic_info": {
            "database_address": "mongodb://localhost:27017",
            "database_name": "mq_server",
            "table_names": ["mq_data", "device_info", "log_records"]
        },
        "delete_settings": {
            "database_delete": false,
            "table_delete": ["mq_data", "device_info", "log_records"]
        }
    },
    "mq_config": {
        "service_address": "0.0.0.0",
        "service_port": 8500,
        "running_status": true,
        "connection_timeout": 2,
        "ping_timeout": 2,
        "pong_timeout": 2,
        "close_timeout": 2
    }
}
```

### 配置说明

**基础信息**

- `database_address`: MongoDB 数据库的连接地址，支持包含账户密码的认证连接格式。
- `database_name`: 消息队列数据存储的数据库名。
- `table_names`: 消息队列数据、设备信息与日志记录对应的数据表名。

**删除设置**

- `database_delete`: 启动服务时，是否删除整个数据库 (`true` 或 `false`)。
- `table_delete`: 启动服务时，删除指定数据表。

**消息队列配置**

- `service_address`: WebSocket 服务器绑定的网络地址。
- `service_port`: WebSocket 服务器监听的端口号。
- `running_status`: 服务器是否启动 (`true` 或 `false`)。
- `connection_timeout`: WebSocket 连接的超时时间。
- `ping_timeout`: WebSocket 的心跳包超时时间。
- `pong_timeout`: WebSocket 的心跳响应超时时间。
- `close_timeout`: WebSocket 连接关闭的超时时间。

## 二、身份验证

### 请求格式

```json
{
    "secret": "your-mac-address",
    "code": "one-time-password",
    "device": "0C:DC:7E:1D:74:D0"
}
```

### 参数说明

- **secret**: 客户端的唯一标识符（如设备 MAC 地址）。
- **code**: 通过 TOTP 算法生成的一次性密码。
- **device**: 设备的唯一标识符。

### 返回示例

#### 验证成功

```json
{
    "uri": "otpauth://totp/Example:alice@google.com?secret=JBSWY3DPEHPK3PXP&issuer=Example",
    "params": {
        "secret": "your-mac-address",
        "code": "one-time-password",
        "device": "0C:DC:7E:1D:74:D0"
    },
    "verified": true,
    "secret": "your-mac-address",
    "interval": 30,
    "digits": 6,
    "algorithm": "SHA1",
    "originalsecret": "raw-secret-key",
    "time": 1735212809
}
```

#### 验证失败

```json
{
    "uri": "otpauth://totp/Example:alice@google.com?secret=JBSWY3DPEHPK3PXP&issuer=Example",
    "params": {
        "secret": "your-mac-address",
        "code": "one-time-password",
        "device": "0C:DC:7E:1D:74:D0"
    },
    "verified": false,
    "secret": "your-mac-address",
    "interval": 30,
    "digits": 6,
    "algorithm": "SHA1",
    "originalsecret": "raw-secret-key",
    "time": 1735212809
}
```

### 注意事项

- 若验证成功，客户端可保持连接，继续进行数据交互。
- 若验证失败或超时未发送验证数据（默认超时时间 10 秒），服务器将断开连接。

## 三、查询数据

### 请求格式

```json
{"$query": {"device": "0C:DC:7E:1D:74:D0"}}
```

### 返回示例

#### 消息总量

```
1
```

#### 详细数据

```json
{
    "send": ["127.0.0.1", 8000],
    "receive": ["127.0.0.1", 62749],
    "device": "b81ea4ce0dc4",
    "code": "264249",
    "duration": 3600,
    "time": 1735211708,
    "verified": true
}
```

### 注意事项

- 消息总量和详细数据以流消息的形式返回。

## 四、发送消息

### 请求格式

```json
{
    "send": ["127.0.0.1", 8000],
    "receive": ["127.0.0.1", 63589],
    "device": "b81ea4ce0dc4",
    "custom-field": "custom-value",
    "data": {}
}
```

### 返回示例

#### 发送成功

```json
{
    "status": true,
    "send": ["127.0.0.1", 8000],
    "receive": ["127.0.0.1", 63589]
}
```

#### 发送失败

```json
{
    "status": false,
    "send": ["127.0.0.1", 8000],
    "receive": ["127.0.0.1", 63371]
}
```

### 注意事项

- **全局唯一标识符**：大流程需要设置成全局唯一标识符。

## 五、接收消息

```json
{
    "send": ["127.0.0.1", 63589],
    "receive": ["127.0.0.1", 8000],
    "time": 1735213767,
    "device": "b81ea4ce0dc4",
    "custom-field": "custom-value",
    "data": {}
}
```

### 注意事项

- `send` 和 `receive` 的字段值会自动对调，以便于应用程序直接处理和转发。

## 六、技术指标

### 性能测试报告

- **单次消息处理时间**: 在运行 `i7-1185G7 @ 3.0GHz` 环境下，小于 5 毫秒。
- **内存占用**: 小于 1MB。
- **并发处理能力**: 支持 1000+ 并发连接。

### 压力测试

- **持续运行测试**: 处理 1,000,000 次消息时，无内存泄漏风险。
- **错误处理**: 连续处理 1,000 次错误输入时，仍能保持系统稳定运行。

### 兼容平台

- **Python 版本**: 3.8+。
- **操作系统**: Windows/Linux/macOS。
- **架构支持**: x86/x64/ARM。

## 七、安全特性

### 数据访问控制

- 只有通过 TOTP 验证的合法客户端，才能进行数据交互。
- 数据在传输过程中可能需要加密（如配合 TLS/SSL 证书使用 WebSocket）。

### 日志记录

- 所有连接请求、数据交互和错误信息均会被记录到 MongoDB 的日志记录表，仅存储验证相关信息，如验证结果、时间戳等，用于后续分析和审计。

### 敏感信息保护

- 客户端发送的敏感信息（如密码）不会被记录到日志中，仅存储验证相关的信息。

## 八、技术支持与联系方式

- 如果您在使用过程中遇到问题，请联系我们的技术支持团队。
- **邮箱**: [support@yourcompany.com](mailto:support@yourcompany.com)
- **官方网站**: [https://www.yourcompany.com](https://www.yourcompany.com/)

如果您在访问官方网站时遇到问题，请检查网页链接的合法性，并适当重试。如果问题仍然存在，请联系技术支持团队获取帮助。
