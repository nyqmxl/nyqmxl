# Commonlib 项目

## 项目简介

Commonlib 是一个综合性工具库，旨在为开发人员提供一系列通用、可复用的模块，涵盖消息队列、自动化客户端、HTML 转换工具等多个领域，适用于多种应用场景，助力开发效率提升。

## 功能模块架构

  1. **消息队列数据库系统** ：基于 WebSocket，用于实时管理交互消息队列数据，高效安全，支持多平台设备，适用于低延迟通信高并发场景。
  2. **自动化客户端程序** ：基于 WebSocket 实现客户端与服务器实时通信，支持身份验证、消息处理、错误处理和自动重连等功能。
  3. **HTML 到 XPath 转换器模块** ：提供从 HTML 字符串或文件生成精确 XPath 路径的工具，并输出结构化 JSON 数据。
  4. **动态功能调用与交互架构** ：支持动态加载功能模块，实现任务顺序执行与数据共享，简化用户操作，提高系统灵活性。
  5. **设备接入与通信架构** ：管理设备接入请求与身份验证，负责设备间消息管理及状态监控，确保设备数据安全传输可靠处理。

## 项目目录结构

```
├─README.md
│
└─src
    │  动态功能调用与交互架构.md
    │  设备接入与通信架构.md
    │
    ├─autoxjs
    │      automated_client.js
    │      自动化客户端说明文档.md
    │
    ├─html_to_json
    │      HtmlToJson.py
    │      HTML到XPath转换器模块文档.md
    │
    └─mq
            mfa.py
            mq.py
            mq_web.py
            消息队列说明.md
```

## 技术规范文档

### 动态功能调用与交互架构

本架构旨在实现系统的动态功能调用与交互，具有以下关键特性：

  * **模块加载组件** ：负责动态加载功能模块，支持从本地文件系统、网络远程仓库等多种途径加载模块，确保系统的扩展性和更新能力。采用延迟加载策略，仅在功能被实际请求时才加载相应模块，减少初始加载时间并节省内存资源，同时支持热更新功能。
  * **结构解析组件** ：对加载的模块进行深入解析，提取类定义、方法签名、参数列表等结构信息，为后续功能调用提供元数据支持。运用抽象语法树（AST）解析技术或反射机制，分析模块源代码或字节码，识别其中的类、方法、函数等结构元素。
  * **方法映射组件** ：构建功能调用映射表，将模块中的类和方法与唯一标识符关联起来，方便快速定位和调用功能。同时管理方法的元数据，如参数列表、返回类型等，为调用执行提供详细信息。
  * **调用执行组件** ：根据用户请求和方法映射信息，执行对应功能调用，并返回调用结果。管理调用过程中的资源分配、线程调度和结果反馈，确保调用的高效性和可靠性。
  * **配置管理组件** ：集中管理系统配置参数，如模块加载路径、调用超时时间、线程池大小等，为各组件提供统一配置访问接口，确保系统灵活配置。
  * **错误处理组件** ：处理系统中的错误和异常情况，记录错误信息、分析原因，并向用户发送错误反馈，同时采取恢复措施，保障系统稳定性和可用性。

### 设备接入与通信架构

本架构专注于设备的分布式接入、消息管理和设备状态监控，具有以下核心要点：

  * **设备接入组件** ：处理设备接入请求，执行身份验证，确保只有合法设备接入系统。与安全认证组件紧密合作，验证设备提交的多因素认证（MFA）信息，包括 TOTP 验证码、设备唯一标识等。
  * **消息队列组件** ：管理设备间的消息传递，确保消息的有序、可靠传输，支持消息缓存和转发。采用内存缓存结合硬盘持久化存储方式，保障数据安全与系统稳定，具备容灾设计，如消息持久化、多副本备份、故障转移等机制。
  * **设备管理组件** ：全面管理设备注册、更新、状态监控及生命周期，维护设备实时状态信息。支持设备分组管理、权限控制、远程配置等功能，便于对大量设备进行分类管理和统一运维。
  * **数据库组件** ：采用 MongoDB 作为存储后端，存储设备信息、消息缓存、日志记录等数据，提供数据存储和查询服务。具备容灾设计，如数据备份、主从复制、故障转移等机制，利用 MongoDB 的文档存储模式、高读写速度和水平扩展能力，满足系统对数据存储和查询的性能要求。
  * **WebSocket 通信组件** ：建立设备与服务器之间的实时双向通信通道，支持低延迟、高可靠性的数据传输。采用多线程架构和线程池优化技术，确保通信的实时性和高效性，同时具备故障转移能力，保障通信连续性。
  * **安全认证组件** ：提供多因素认证（MFA）功能，确保设备接入安全性。生成 TOTP 密钥并分发给设备，验证设备提交的验证码，管理会话并生成会话令牌，记录认证过程信息，具备认证信息持久化和故障转移等容灾能力。

## 模块详细说明

### 自动化客户端

  * **功能概述** ：实现基于 WebSocket 的客户端，与服务器实时通信，支持身份验证、消息处理、错误处理和自动重连等功能。
  * **配置文件** ：存储路径为 `/storage/emulated/0/auto_config.json`，包含 `config` 和 `message` 两部分配置项。
  * **程序模块** ：包括 `_open_`（身份验证）、`_message_`（接收处理服务器消息）、`_error_`（处理连接错误事件）、`_close_`（处理连接关闭事件）、`_websocket_`（管理 WebSocket 连接）、`main`（初始化启动客户端）等函数。

### HTML 到 XPath 转换器模块

  * **功能概述** ：从 HTML 字符串或文件生成精确 XPath 路径，输出结构化 JSON 数据。
  * **核心功能** ：多源输入处理、智能 XPath 生成、动态命名空间管理、结构化数据输出、数据扫描工具、模块文档生成器、浏览器自动化工具。
  * **功能类** ：`HTMLToJSON` 类（实现 HTML 解析与 XPath 生成核心功能）、`Scanner` 类（在嵌套数据结构中递归搜索目标字符串）。

### 消息队列数据库系统

  * **功能概述** ：基于 WebSocket 的消息队列数据库系统，用于实时管理和交互消息队列数据。
  * **配置服务端** ：配置文件包含数据库连接地址、数据库名、数据表名等基础信息，以及 WebSocket 服务器相关配置。
  * **身份验证** ：客户端发送包含 `secret`、`code`、`device` 的验证请求，服务器验证并返回结果。
  * **数据操作** ：支持查询、发送和接收消息等操作。

## 开发规范

在开发过程中，所有代码必须严格遵守以下技术规范文档：

  * **动态功能调用与交互架构** ：开发人员应遵循该架构规范，确保系统的动态扩展性、高效调用、可靠性等特性得以实现。
  * **设备接入与通信架构** ：开发人员应遵循该架构规范，确保设备接入、消息传递、设备管理等流程的稳定性和安全性。

## 技术支持与联系方式

在使用 Commonlib 项目过程中，若遇到问题，可联系内部成员获取帮助。
